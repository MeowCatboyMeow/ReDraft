<div id="redraft_settings">
    <div class="inline-drawer">
        <div class="inline-drawer-toggle inline-drawer-header">
            <b>ReDraft</b>
            <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
        </div>
        <div class="inline-drawer-content">

            <!-- Top-level toggles -->
            <label class="checkbox_label">
                <input type="checkbox" id="redraft_enabled" />
                <span>Enable ReDraft</span>
            </label>
            <label class="checkbox_label">
                <input type="checkbox" id="redraft_auto_refine" />
                <span>Auto-refine new AI messages</span>
            </label>
            <label class="checkbox_label">
                <input type="checkbox" id="redraft_show_diff" />
                <span>Show diff after refinement</span>
            </label>

            <!-- Connection Section -->
            <div class="inline-drawer">
                <div class="inline-drawer-toggle inline-drawer-header">
                    <span>Connection <span id="redraft_status_dot" class="redraft-status-dot"
                            title="Not configured"></span></span>
                    <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
                </div>
                <div class="inline-drawer-content">
                    <div class="redraft-form-group">
                        <label for="redraft_connection_mode">Refinement Mode</label>
                        <select id="redraft_connection_mode">
                            <option value="st">Use current ST connection</option>
                            <option value="plugin" disabled>Separate LLM (Coming Soon)</option>
                        </select>
                    </div>

                    <!-- Plugin connection fields (shown only in plugin mode) -->
                    <div id="redraft_plugin_fields" style="display: none;">
                        <div class="redraft-form-group">
                            <label for="redraft_api_url">API URL</label>
                            <input id="redraft_api_url" type="text" class="text_pole"
                                placeholder="https://api.openai.com/v1" />
                        </div>
                        <div class="redraft-form-group">
                            <label for="redraft_api_key">API Key</label>
                            <input id="redraft_api_key" type="password" class="text_pole" placeholder="sk-..."
                                autocomplete="off" />
                        </div>
                        <div class="redraft-form-group">
                            <label for="redraft_model">Model</label>
                            <input id="redraft_model" type="text" class="text_pole" placeholder="gpt-4o-mini" />
                        </div>
                        <div class="redraft-form-group">
                            <label for="redraft_max_tokens">Max Tokens</label>
                            <input id="redraft_max_tokens" type="number" class="text_pole" placeholder="4096" min="1"
                                max="128000" />
                        </div>
                        <div class="redraft-button-row">
                            <div id="redraft_save_connection" class="menu_button">
                                <i class="fa-solid fa-save"></i>
                                <span>Save Connection</span>
                            </div>
                            <span id="redraft_connection_info" class="redraft-connection-info"></span>
                        </div>
                    </div>

                    <!-- ST mode info -->
                    <div id="redraft_st_mode_info" class="redraft-st-mode-info">
                        <small>Refinement will use your currently selected API and model in SillyTavern.</small>
                    </div>
                </div>
            </div>

            <!-- Rules Section -->
            <div class="inline-drawer">
                <div class="inline-drawer-toggle inline-drawer-header">
                    <span>Rules</span>
                    <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
                </div>
                <div class="inline-drawer-content">
                    <small class="redraft-section-hint">Active rules are sent to the refinement LLM along with the
                        message.</small>

                    <div class="redraft-rules-builtins">
                        <label class="checkbox_label"
                            title="Fix grammatical errors, spelling mistakes, and awkward phrasing. Preserves intentional dialect, slang, and character-specific speech.">
                            <input type="checkbox" id="redraft_rule_grammar" />
                            <span>Fix grammar &amp; spelling</span>
                        </label>
                        <label class="checkbox_label"
                            title="Remove sentences where the character restates or paraphrases the user's previous message instead of advancing the scene.">
                            <input type="checkbox" id="redraft_rule_echo" />
                            <span>Remove echo &amp; restatement</span>
                        </label>
                        <label class="checkbox_label"
                            title="Reduce repeated gestures, sentence structures, and emotional beats within the response and compared to the previous one.">
                            <input type="checkbox" id="redraft_rule_repetition" />
                            <span>Reduce repetition</span>
                        </label>
                        <label class="checkbox_label"
                            title="Ensure each character's dialogue is distinct and consistent with their established speech patterns and personality.">
                            <input type="checkbox" id="redraft_rule_voice" />
                            <span>Maintain character voice</span>
                        </label>
                        <label class="checkbox_label"
                            title="Fix common AI prose weaknesses: somatic clichés, purple prose, filter words, and telling over showing.">
                            <input type="checkbox" id="redraft_rule_prose" />
                            <span>Clean up prose</span>
                        </label>
                        <label class="checkbox_label"
                            title="Fix orphaned formatting marks, inconsistent style, and dialogue punctuation errors.">
                            <input type="checkbox" id="redraft_rule_formatting" />
                            <span>Fix formatting</span>
                        </label>
                        <label class="checkbox_label"
                            title="Remove theatrical 'dismount' endings — crafted landing lines that make the response feel concluded instead of mid-scene.">
                            <input type="checkbox" id="redraft_rule_ending" />
                            <span>Fix crafted endings</span>
                        </label>
                        <label class="checkbox_label"
                            title="Flag glaring contradictions with established character and world information. Won't invent new lore.">
                            <input type="checkbox" id="redraft_rule_lore" />
                            <span>Maintain lore consistency</span>
                        </label>
                    </div>

                    <hr />

                    <div class="redraft-custom-rules-header">
                        <label class="checkbox_label" style="margin:0;gap:4px;">
                            <input type="checkbox" id="redraft_custom_rules_toggle"
                                title="Enable/disable all custom rules" />
                            <small>Custom Rules (ordered by priority)</small>
                        </label>
                        <div>
                            <div id="redraft_import_rules" class="menu_button menu_button_icon"
                                title="Import rules from JSON">
                                <i class="fa-solid fa-file-import"></i>
                            </div>
                            <input type="file" id="redraft_import_rules_file" accept=".json" hidden />
                            <div id="redraft_export_rules" class="menu_button menu_button_icon"
                                title="Export rules to JSON">
                                <i class="fa-solid fa-file-export"></i>
                            </div>
                            <div id="redraft_add_rule" class="menu_button menu_button_icon" title="Add custom rule">
                                <i class="fa-solid fa-plus"></i>
                            </div>
                        </div>
                    </div>

                    <div id="redraft_custom_rules_list" class="redraft-custom-rules-list">
                        <!-- Custom rules injected here by JS -->
                    </div>
                </div>
            </div>

            <!-- Advanced Section -->
            <div class="inline-drawer">
                <div class="inline-drawer-toggle inline-drawer-header">
                    <span>Advanced</span>
                    <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
                </div>
                <div class="inline-drawer-content">
                    <div class="redraft-form-group redraft-pov-group">
                        <label for="redraft_pov">Point of View</label>
                        <select id="redraft_pov">
                            <option value="auto">Auto (no instruction)</option>
                            <option value="detect">Detect from message</option>
                            <option value="1st">1st person (I/me)</option>
                            <option value="1.5">1.5th person (I + you)</option>
                            <option value="2nd">2nd person (you)</option>
                            <option value="3rd">3rd person (he/she/they)</option>
                        </select>
                    </div>
                    <div class="redraft-form-group">
                        <label for="redraft_system_prompt">System Prompt Override</label>
                        <textarea id="redraft_system_prompt" class="text_pole textarea_compact" rows="3"
                            style="resize:vertical;field-sizing:content;max-height:50vh;"
                            placeholder="Leave blank for default refinement prompt..."></textarea>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Floating Popout Panel (injected near bottom of body by JS) -->
<div id="redraft_popout_panel" class="redraft-popout-panel" style="display: none;">
    <div class="redraft-popout-header">
        <span class="redraft-popout-title">ReDraft</span>
        <div id="redraft_popout_close" class="dragClose" title="Close">
            <i class="fa-solid fa-xmark"></i>
        </div>
    </div>
    <div class="redraft-popout-body">
        <label class="checkbox_label">
            <input type="checkbox" id="redraft_popout_auto" />
            <span>Auto-refine</span>
        </label>
        <div id="redraft_popout_status" class="redraft-popout-status"></div>
        <div id="redraft_popout_refine" class="menu_button">
            <i class="fa-solid fa-pen-nib"></i>
            <span>Refine Last Message</span>
        </div>
        <div id="redraft_popout_open_settings" class="menu_button">
            <i class="fa-solid fa-gear"></i>
            <span>Full Settings</span>
        </div>
    </div>
</div>